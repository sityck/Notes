# 云原生安全

目前接触到的云原生安全风险有两块：

一块是组件及OS漏洞导致的安全缺陷，这一类在研发安全中主要靠开源漏洞管理以及对应的镜像更新管理来管控；

一块是不安全配置导致的安全风险，有因为开发在编写代码时预配置不规范导致的，也有因为开发开放了一些能够进行不安全配置的能力导致的。

## 容器逃逸

该章节从两种风险来源来进行介绍具体的利用手段：[PODSec.md](PODSec.md)

### 安全容器逃逸

安全容器通常的结构是：在宿主机上运行一个独立的虚拟机，再在虚拟机内运行容器；那么攻击者就需要进行容器逃逸与虚拟机逃逸。

在2020年的Black Hat北美会议上，提出了关于安全容器Kata Containers的逃逸路线，其依赖于如下漏洞：

1）CVE-2020-2023：KC可以不受限的访问虚拟机的根文件系统设备；

2）CVE-2020-2024：KC运行时在卸载挂载点时存在符号链接解析漏洞，允许针对宿主机的拒绝服务攻击；

3）CVE-2020-2025：基于Cloud Hypervisor的KC会将虚拟机文件系统的改动写入到虚拟机镜像文件里；

4）CVE-2020-2026：KC运行时在挂载容器根文件系统时存在符号链接解析漏洞，可能允许攻击者在宿主机上执行任意代码；

**影响范围：** Kata Containers 1.11.1之前的1.11版本、1.10.5之前的1.10版本和1.9及之前版本

攻击路径复现：[安全容器逃逸经典案例](KCSec.md)

## 镜像安全

镜像安全也是云原生安全中极为重要的一环，镜像中的组件存在开源漏洞或者泄露敏感数据，镜像仓库中存在恶意镜像等问题都可能导致云系统集群的不安全性。但这一块主要为安全运营管理的问题。

在实际测试过程中；我们主要应关注于

1、当前容器镜像存在哪些开源漏洞 -- 理应由公司整体提供镜像漏洞扫描；

2、当前容器来源于哪个镜像，初始镜像中的凭证是否做了更改；

3、镜像仓库是否是可信的，是否存在上传恶意镜像的可能。

## 主机安全

当宿主机上安装了Docker时，一旦出现Docker配置缺陷，那么就能够危害到宿主机内部的安全机制。

### 主机提权

#### 1、UNIX socket不安全配置

当用户为了方便，将主机普通用户加入Docker用户组时，普通用户就拥有了UNIX socket守护进程的访问权限，那么普通用户通过与该进程进行交互，即可通过该进行以root权限在宿主机上执行任意命令。

可用攻击路径见下方图片，简单来讲就是通过恶意挂载使得我们使用容器内的root用户修改宿主机的root所属权限的文件，从而将普通用户提权至SUDO组（linux机器上的本地用户信息主要记录在`/etc/`目录下，比如两个常见文件`/etc/passwd`和`/etc/group`两个文件分别记录了用户基本属性与用户分组信息；此处便是把etc目录挂载到容器内了）：

![](G:\ired.team\Notes\img\294874.jpg)

## 组件安全

云原生的整个机制都是基于各类组件运转的，组件存在漏洞往往会影响整个云原生系统的安全性

### 未授权漏洞

#### 1、TCP socket默认配置导致的未授权

默认情况下Docker并不会监听TCP socket，但是用户可以配置针对该socket的监听，这个监听端口一般是2375端口。

而该监听路径通常是无加密、无认证的；所以我们能够通过例如以下命令直接对Docker发送指令，而无需任何授权：

```
docker -H tcp://192.168.1.1:2375 ps   #列出所有活动容器
```

